generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
  relationMode = "prisma"
}

model Payment {
  id             String        @id @default(uuid())
  bookingId      String        @unique
  userId         String
  amount         Decimal       @db.Decimal(10,2)
  currency       String        @default("LKR")
  feeAmount      Decimal?      @db.Decimal(10,2)
  netAmount      Decimal?      @db.Decimal(10,2)
  psp            String
  pspPaymentId   String?       @unique
  pspReference   String?
  paymentMethod  String
  status         String        @default("CREATED")
  idempotencyKey String?       @unique
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  expiresAt      DateTime?
  events         PaymentEvent[]
  refunds        Refund[]
}

model PaymentEvent {
  id           String   @id @default(uuid())
  paymentId    String
  eventType    String
  eventSource  String
  payload      Json
  statusBefore String?
  statusAfter  String?
  createdAt    DateTime @default(now())

  payment      Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
}

model Refund {
  id           String   @id @default(uuid())
  paymentId    String
  amount       Decimal  @db.Decimal(10,2)
  currency     String   @default("LKR")
  pspRefundId  String?  @unique
  reason       String?
  status       String   @default("PENDING")
  initiatedBy  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  payment      Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
}

model IdempotencyKey {
  key            String   @id
  requestHash    String   @unique
  responseStatus Int?
  responseBody   Json?
  expiresAt      DateTime?
  createdAt      DateTime @default(now())
}
