generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
  binaryTargets  = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")
}

model Payment {
  id             String        @id @default(uuid())
  bookingId      String
  userId         String
  amount         Decimal       @db.Decimal(10,2)
  currency       String        @default("LKR")
  psp            String
  pspPaymentId   String?
  pspReference   String?
  paymentMethod  String
  status         String        @default("CREATED")
  metadata       Json?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  expiresAt      DateTime?
  events         PaymentEvent[]

  @@unique([bookingId])
  @@unique([pspPaymentId])
  @@index([bookingId])
  @@index([userId])
  @@index([pspPaymentId])
  @@index([status])
  @@index([createdAt])
}

model PaymentEvent {
  id           String   @id @default(uuid())
  paymentId    String?
  eventType    String
  eventSource  String
  payload      Json
  statusBefore String?
  statusAfter  String?
  createdAt    DateTime @default(now())

  payment      Payment?  @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([eventType])
  @@index([createdAt])
}
